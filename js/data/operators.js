import { factorial, triangular, rectangular } from '../utils/math.js';

export const OPERATORS = {
  add: {
    symbol: '+',
    name: 'Add',
    precedence: 1,
    arity: 2,
    fn: (a, b) => a + b,
    rarity: 'common',
    cost: 10,
    description: 'Add two numbers',
  },
  subtract: {
    symbol: '\u2212',
    name: 'Subtract',
    precedence: 1,
    arity: 2,
    fn: (a, b) => a - b,
    rarity: 'common',
    cost: 10,
    description: 'Subtract right from left',
  },
  multiply: {
    symbol: '\u00d7',
    name: 'Multiply',
    precedence: 2,
    arity: 2,
    fn: (a, b) => a * b,
    rarity: 'common',
    cost: 15,
    description: 'Multiply two numbers',
  },
  divide: {
    symbol: '\u00f7',
    name: 'Divide',
    precedence: 2,
    arity: 2,
    fn: (a, b) => b === 0 ? NaN : a / b,
    rarity: 'uncommon',
    cost: 25,
    description: 'Divide left by right',
  },
  power: {
    symbol: '^',
    name: 'Power',
    precedence: 3,
    arity: 2,
    fn: (a, b) => Math.pow(a, b),
    rarity: 'rare',
    cost: 50,
    description: 'Raise left to the power of right',
  },
  modulo: {
    symbol: '%',
    name: 'Modulo',
    precedence: 2,
    arity: 2,
    fn: (a, b) => b === 0 ? NaN : ((a % b) + b) % b,
    rarity: 'uncommon',
    cost: 30,
    description: 'Remainder after division',
  },
  log: {
    symbol: 'log',
    name: 'Logarithm',
    precedence: 3,
    arity: 2,
    fn: (a, b) => (a <= 0 || a === 1 || b <= 0) ? NaN : Math.log(b) / Math.log(a),
    rarity: 'rare',
    cost: 55,
    description: 'Log base left of right (2 log 8 = 3)',
  },
  concat: {
    symbol: '||',
    name: 'Concat',
    precedence: 0,
    arity: 2,
    fn: (a, b) => Number(`${Math.floor(a)}${Math.floor(b)}`),
    rarity: 'exotic',
    cost: 90,
    description: 'Concatenate digits (3 || 4 = 34)',
  },
  negate: {
    symbol: '\u00b1',
    name: 'Negate',
    precedence: 4,
    arity: 1,
    position: 'prefix',
    fn: (a) => -a,
    rarity: 'uncommon',
    cost: 20,
    description: 'Flip the sign of a number',
  },
  sqrt: {
    symbol: '\u221a',
    name: 'Square Root',
    precedence: 4,
    arity: 1,
    position: 'prefix',
    fn: (a) => a < 0 ? NaN : Math.sqrt(a),
    rarity: 'rare',
    cost: 50,
    description: 'Square root of a number',
  },
  factorial: {
    symbol: '!',
    name: 'Factorial',
    precedence: 4,
    arity: 1,
    position: 'postfix',
    fn: (a) => factorial(a),
    rarity: 'legendary',
    cost: 100,
    description: 'Factorial (max 12!)',
  },
  triangle: {
    symbol: '\u25B3',
    name: 'Triangle',
    precedence: 4,
    arity: 1,
    position: 'postfix',
    fn: (a) => triangular(a),
    rarity: 'uncommon',
    cost: 30,
    description: 'Triangular: 3△=6, 4△=10, 5△=15, 6△=21',
  },
  rectangle: {
    symbol: '\u25AD',
    name: 'Rectangle',
    precedence: 4,
    arity: 1,
    position: 'postfix',
    fn: (a) => rectangular(a),
    rarity: 'uncommon',
    cost: 30,
    description: 'Rectangular: 3▭=12, 4▭=20, 5▭=30, 6▭=42',
  },
  lparen: {
    symbol: '(',
    name: 'Left Paren',
    precedence: -1,
    arity: 0,
    paren: 'left',
    rarity: 'uncommon',
    cost: 0,
    description: 'Open a group — must pair with )',
  },
  rparen: {
    symbol: ')',
    name: 'Right Paren',
    precedence: -1,
    arity: 0,
    paren: 'right',
    rarity: 'uncommon',
    cost: 0,
    description: 'Close a group — must pair with (',
  },
};

export function getStartingOperators() {
  return ['add', 'subtract', 'multiply', 'lparen', 'rparen'];
}

export function getOperatorsByRarity(rarity) {
  return Object.entries(OPERATORS)
    .filter(([, op]) => op.rarity === rarity)
    .map(([key]) => key);
}
